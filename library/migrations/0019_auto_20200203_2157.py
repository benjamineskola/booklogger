# Generated by Django 3.0.2 on 2020-02-03 21:57

import django.db.models.deletion
import django.db.models.functions.text
from django.db import migrations, models


def move_book_author_to_first_author(apps, schema_editor):
    Book = apps.get_model("library", "Book")
    for book in Book.objects.all():
        first_author = book.bookauthor_set.first()
        if first_author:
            book.first_author_id = first_author.author.id
            book.first_author_role = first_author.role
            book.save()
            first_author.delete()
        else:
            print(f"{book.title} has no author? {book.bookauthor_set.all()}")


def move_first_author_to_book_author(apps, schema_editor):
    Book = apps.get_model("library", "Book")
    BookAuthor = apps.get_model("library", "BookAuthor")
    for book in Book.objects.all():
        ba = BookAuthor(
            book=book, author=book.first_author, role=book.first_author_role, order=1
        )
        ba.save()


class Migration(migrations.Migration):

    dependencies = [
        ("library", "0018_pgext_20200202_0845"),
    ]

    operations = [
        migrations.AlterModelOptions(
            name="book",
            options={
                "ordering": [
                    django.db.models.functions.text.Lower("first_author__surname"),
                    django.db.models.functions.text.Lower("first_author__forenames"),
                    "series",
                    "series_order",
                    "title",
                ]
            },
        ),
        migrations.RenameField(
            model_name="book", old_name="authors", new_name="additional_authors",
        ),
        migrations.AddField(
            model_name="book",
            name="first_author",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                to="library.Author",
            ),
        ),
        migrations.AddField(
            model_name="book",
            name="first_author_role",
            field=models.CharField(
                db_index=True, max_length=255, blank=True, null=True
            ),
        ),
        migrations.RunPython(
            move_book_author_to_first_author, move_first_author_to_book_author
        ),
    ]
