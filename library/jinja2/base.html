{% from "macros.html" import nav_link with context %}
{% set book_pages = [
('All', 'library:books_all'),
('Owned', 'library:books_owned'),
('By Date', 'library:books_owned_by_date'),
('Borrowed', 'library:books_borrowed'),
('Reading', 'library:books_currently_reading'),
('Read', 'library:books_read'),
('To Read', 'library:books_to_read'),
('Wishlist', 'library:books_unowned'),
('Reviewed', 'library:books_reviewed'),
('Unreviewed', 'library:books_unreviewed'),
] %}
{% set other_pages = [
('Authors', 'library:author_list'),
('Publishers', 'library:publisher_index'),
('Series', 'library:series_index'),
('Tags', 'library:tag_cloud'),
('Stats', 'library:stats')
] %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ static("style.css") }}?_v={{ VERSION_NUMBER }}">
    <title>{% if page_title %}{{ page_title }} — {% endif %}Booklogger</title>
    <script src="http://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="{{ static("script.js") }}?_v={{ VERSION_NUMBER }}"></script>
    {% block header %}
    {% endblock %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-toggle" aria-controls="navbar-toggle" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar-toggle">
        <a class="navbar-brand" href="{{ url("library:index") }}">Booklogger</a>
        <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="books_dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Books
            </a>
            <div class="dropdown-menu" aria-labelledby="books_dropdown">
              {% for title, link in book_pages %}
                {{ nav_link(title, link, "dropdown-item") }}
              {% endfor %}
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="collections_dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Collections
            </a>
            <div class="dropdown-menu" aria-labelledby="collections_dropdown">
              {% for title, link in other_pages %}
                {{ nav_link(title, link, "dropdown-item") }}
              {% endfor %}
            </div>
          </li>
        </ul>
        <form class="form-inline my-2 my-lg-0" action="{{ url('library:basic_search') }}">
          <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search" name="query">
        </form>
        <ul class="navbar-nav mt-2 mt-lg-0">
          {% if user.is_authenticated %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="admin_dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Admin
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="admin_dropdown">
                {{ nav_link("Admin", "admin:index", "dropdown-item") }}
                {{ nav_link("Create Author", "library:author_new", "dropdown-item") }}
                {{ nav_link("Create Book", "library:book_new", "dropdown-item") }}
                {{ nav_link("Goodreads Import", "library:book_import", "dropdown-item") }}
                {{ nav_link("Bulk Import", "library:bulk_import", "dropdown-item") }}
                {{ nav_link("Reports", "library:report", "dropdown-item") }}
                {% if request.get_host() == "booklogger.eskola.uk" %}
                  <a class="dropdown-item" href="http://localhost:8000{{ url(request.resolver_match.view_name, kwargs=request.resolver_match.kwargs) }}">Development</a>
                {% else %}
                  <a class="dropdown-item" href="http://booklogger.eskola.uk{{ url(request.resolver_match.view_name, kwargs=request.resolver_match.kwargs) }}">Production</a>
                {% endif %}
                <div class="divider"></div>
                <span class="dropdown-item">Release
                  {% if VERSION_NUMBER %}
                    {{ VERSION_NUMBER }}
                    {% if COMMIT_ID %}
                      ({{ COMMIT_ID }})
                    {% endif %}
                  {% else %}
                    unknown
                  {% endif %}
                </span>
              </div>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url('admin:login') }}?next={{ request.get_full_path () }}">Log In</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    <main class="container mb-2">
      {% if page_title and request.resolver_match.url_name != 'book_details' %}
        <h1 class="ui header">
          {{ page_title }}
        </h1>
      {% endif %}
      {% block content %}
      {% endblock %}

      {% if page_obj and page_obj.paginator and page_obj.paginator.num_pages > 1 %}
        {% set params = request.GET.copy() %}
        {% set qs = params.urlencode() %}
        <div class="ui center aligned container" style="margin-top: 2em">
          <nav class="ui stackable pagination menu">
            {% if request.resolver_match.kwargs["format"] %}
              {% set new_kwargs= {"format": request.resolver_match.kwargs["format"]} %}
            {% elif request.resolver_match.kwargs["tag_name"] %}
              {% set new_kwargs= {"tag_name": request.resolver_match.kwargs["tag_name"]} %}
            {% elif request.resolver_match.kwargs["publisher"] %}
              {% set new_kwargs= {"publisher": request.resolver_match.kwargs["publisher"]} %}
            {% else %}
              {% set new_kwargs = {} %}
            {% endif %}

            {% if page_obj.number > 1 %}
              {% if page_obj.previous_page_number() > 1 %}
                {% set prev_kwargs = dict(new_kwargs, **{"page": page_obj.previous_page_number()}) %}
              {% else %}
                {% set prev_kwargs = new_kwargs %}
              {% endif %}

              <a class="item" href="{{ url(request.resolver_match.view_name, kwargs=prev_kwargs) }}{% if qs %}?{{ qs }}{% endif %}">&laquo;</a>
            {% else %}
              <span class="disabled item">&laquo;</span>
            {% endif %}

            {% for pageno in page_obj.paginator.page_range %}

              {% if page_obj.paginator.num_pages < 10 or pageno == 1 or pageno == page_obj.paginator.num_pages or (pageno > page_obj.number - 3 and pageno < page_obj.number + 3) %}
                {% if pageno > 1 %}
                  {% set new_kwargs = dict(new_kwargs, **{"page": pageno}) %}
                {% endif %}
                <a class="item{% if pageno == page_obj.number %} active{% endif %}" href="{{ url(request.resolver_match.view_name, kwargs=new_kwargs) }}{% if qs %}?{{ qs }}{% endif %}">{{ pageno }}</a>
              {% elif pageno == page_obj.number - 3 or pageno == page_obj.number + 3 %}
                <span class="disabled item">…</span>
              {% endif %}
            {% endfor %}

            {% if page_obj.number < page_obj.paginator.num_pages %}
              <a class="item" href="{{ url(request.resolver_match.view_name, kwargs=dict(request.resolver_match.kwargs, **{"page": page_obj.next_page_number()})) }}{% if qs %}?{{ qs }}{% endif %}">&raquo;</a>
            {% else %}
              <span class="disabled item">&raquo;</span>
            {% endif %}
          </nav>
        </div>
      {% endif %}
    </main>

    {% block footer %}
    {% endblock footer %}
  </body>
</html>
