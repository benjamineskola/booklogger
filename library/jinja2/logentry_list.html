{% from "macros/card.html" import book_list with context %}
{% extends "base.html" %}
{% block content %}
  {% if entries and entries[0].currently_reading %}
    {{ book_list(entries) }}
  {% else %}
    {% if entries %}
      {% set display_year = entries.first().end_date.year %}
    {% else %}
      {% set display_year = request.resolver_match.kwargs.get('year') | int %}
    {% endif %}

    {% if not year %}
      {% if display_year == 1 %}
        <h2 class="ui dividing header">Read sometime</h2>
      {% else %}
        <h2 class="ui dividing header">Read in {{ display_year }}</h2>
      {% endif %}
    {% endif %}

    {{ book_list(entries) }}

    {% if not year or request.GET.get('infinite') == 'true' %}
      {% if display_year > 2010 %}
        {% set next_year = display_year - 1 %}
      {% elif display_year == 2010 %}
        {% set next_year = 2007 %}
      {% elif display_year == 2007 %}
        {% set next_year = 2004 %}
      {% else %}
        {% set next_year = "sometime" %}
      {% endif %}

      {% if display_year > 1 %}
        <div class="loader" style="margin-top: 2rem;">
          <div id="loading-{{ next_year }}" class="ui icon message">
            <i class="spinner loading icon"></i>
            Loading {{ next_year }}
          </div>
          <div id="error-{{ next_year }}" class="ui error icon message hidden">
            <i class="exclamation circle icon"></i>
            <div class="content">
              <div class="header">Failed to load {{ next_year }}.</div>
              <p><span class="ui basic negative button">Retry?</span></p>
            </div>
          </div>
        </div>
        <script>
          setTimeout(function () {
          {% set params = request.GET.copy() %}
          {% if not 'infinite' in params %}
            {% set _ = params.update({'infinite': 'true'}) %}
          {% endif %}
            load_next_page("{{ next_year }}", "{{ url("library:books_read", kwargs={"year": next_year}) }}?{{ params.urlencode() | safe }}");
          }, 2 * 1000);

          $(".error.message .button").on("click", function () {
            load_next_page("{{ next_year }}", "{{ url("library:books_read", kwargs={"year": next_year}) }}?{{ params.urlencode() | safe }}");
          });
        </script>
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock content %}
