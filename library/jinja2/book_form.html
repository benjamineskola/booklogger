{% from "macros.html" import link_amazon, link_goodreads, link_google with context %}
{% from "macros/card.html" import book_card with context %}
{% extends "base.html" %}
{% block header %}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
  <link rel="stylesheet" href="https://angel-vladov.github.io/select2-theme-bootstrap4/css/select2-bootstrap.css" />
{% endblock %}

{% block content %}
  {% if form.instance.id %}
    <div class="row row-cols-1 row-cols-md-2">
      <div class="col">
        {{ book_card(form.instance) }}
      </div>

      <div class="col">
        <div class="card mb-2">
          <div class="card-body">
            <strong>Amazon</strong> {{ link_amazon(book) }}<br/>
            <strong>Goodreads</strong> {{ link_goodreads(book) }}<br/>
            <strong>Google</strong> {{ link_google(book) }}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if form.errors %}
    <div class="alert alert-danger mb-2">
      {% for error in form.errors %}
        <p><strong>{{ error }}:</strong> {{ form.errors[error] | join('; ') }}</p>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <div class="row row-cols-1 row-cols-md-2">
      {% for field_names in [
        ["title", "subtitle", "first_author", "first_author_role", "first_published", "language", "series", "series_order", "slug"],
        ["edition_title", "edition_subtitle", "publisher", "edition_published", "edition_format", "edition_language", "edition_number", "page_count"],
        ["owned_by", "acquired_date", "alienated_date", "was_borrowed", "borrowed_from", "want_to_read"],
        ["goodreads_id", "google_books_id", "isbn", "asin", "image_url", "publisher_url"],
        ["has_ebook_edition", "ebook_acquired_date", "ebook_isbn", "ebook_asin"],
        ["tags", "review", "rating"],
        ["editions", "parent_edition"],
      ] %}
        {% if 'editions' not in field_names or ('editions' in form.fields or 'parent_edition' in form.fields) %}
          <div class="col">
            <div class="card mb-2">
              <div class="card-body">
                {% for field_name in field_names %}
                  {% set field = form[field_name] %}
                  {% if field %}
                    {{ field | crispy }}
                    {% for error in field.errors %}
                      <label for="{{ field.id_for_label }}" class="alert alert-warning">
                        {{ error|escape }}
                      </label>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              </div> {# card-body #}
            </div> {# card #}
          </div> {# column #}
        {% endif %}
      {% endfor %}
    </div> {# row #}

    {% for inline_formset in inline_formsets %}
      <div class="card mb-2" id="card-{{ inline_formset.prefix }}">
        <div class="card-body" id="formset-{{ inline_formset.prefix }}">
          {% if inline_formset.errors %}
            {% for error in inline_formset.errors %}
              {% if error %}
                <div class="alert alert-danger">
                  {{ error }}
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ inline_formset.management_form }}
          {% for form in inline_formset %}
            <div class="form-inline">
              {{ form.id }}
              {% for field in form %}
                {% if field.name not in ["id", "book"] %}
                  {{ field | crispy(field_class="mr-2 mt-2", label_class="mr-2") }}
                  {% for error in field.errors %}
                    <label for="{{ field.id_for_label }}" class="alert alert-warning">
                      {{ error|escape }}
                    </label>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </div>
          {% endfor %}
        </div> {# card-body #}
        {% if inline_formset.prefix == "bookauthor_set" %}
          <div class="card-footer"><a href="#">Add author</a></div>
        {% elif inline_formset.prefix == "readinglistentry_set" %}
          <div class="card-footer"><a href="#">Add list</a></div>
        {% endif %}
      </div> {# card #}
    {% endfor %}

    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-body">
            <input type="submit" value="Submit" class="btn btn-primary">
            {% if form.instance.id %}
              <a href="{{ form.instance.get_absolute_url() }}" class="btn btn-secondary" role="button">Cancel</a>
              <a href="{{ url("library:book_delete", args=[form.instance.slug]) }}" class="btn btn-danger" role="button">Delete</a>
            {% else %}
              <a href="/" class="btn btn-secondary">Cancel</a>
            {% endif %}
          </div> {# card-body #}
        </div> {# card #}
      </div> {# col #}
    </div> {# row #}
  </form>

  {% if form.instance.id %}
    <a href="{{ url("admin:library_book_change", args=[form.instance.id]) }}">Advanced</a>
  {% endif %}
{% endblock content %}

{% block footer %}
  <script>
    $(document).ready(function() {
        $('select').select2({
          theme: 'bootstrap',
        });
        $('#id_first_author, #id_publisher, #id_series, #formset-bookauthor_set select').select2({
          theme: 'bootstrap',
          tags: true,
        });
        $('#id_tags').select2({
          theme: 'bootstrap',
          tags: true,
          tokenSeparators: [','],
        });
        {% if form.instance %}
        $('#id_tags').val({{ form.instance.tags | json | safe }});
        $('#id_tags').trigger("change");
        {% endif %}
        $('#id_acquired_date_day, #id_alienated_date_day, #id_ebook_acquired_date_day').select2({
          theme: 'bootstrap',
          width: '5em',
        });
        $('#id_acquired_date_month, #id_alienated_date_month, #id_ebook_acquired_date_month').select2({
          theme: 'bootstrap',
          width: '9em',
        });
        $('#id_acquired_date_year, #id_alienated_date_year, #id_ebook_acquired_date_year').select2({
          theme: 'bootstrap',
          tags: true,
          width: '6em',
        });

        $('#id_acquired_date_month, #id_alienated_date_month, #id_ebook_acquired_date_month').parent().addClass('form-row')
        $('#id_acquired_date_month, #id_alienated_date_month, #id_ebook_acquired_date_month').parent().find('span').each(function(){ $(this).addClass('mr-2') })

        $("#card-bookauthor_set .card-footer a").on("click", add_author);
        $("#card-readinglistentry_set .card-footer a").on("click", add_listentry);

        $("#card-bookauthor_set, #card-logentry_set, #card-readinglistentry_set")
          .find(".form-check-input")
          .on("click", function (event) {
            $(this).parent().parent().parent().parent().hide(1000);
          });
    });

  var bookauthor_formset_template = `{{ inline_formsets[0].empty_form }}`;
  var listentry_formset_template = `{{ inline_formsets[2].empty_form }}`;

  function add_author(event) {
    event.preventDefault();

    var parent = $("#formset-bookauthor_set");
    var total_forms = $('input[name="bookauthor_set-TOTAL_FORMS"]');
    var index = parseInt(total_forms.val());

    var inline_form = $('<div class="form-inline"></div>');
    var select_field = $(
      bookauthor_formset_template.replace(/__prefix__/g, index)
    ).find("select");

    var author_form_group = $('<div class="form-group"></div>');
    author_form_group.append(
      `<label for="id_bookauthor_set-${index}-author" class="mr-2 requiredField">Author*</label>`
    );
    var select_div = $('<div class="mr-2 mt-2"></div>');
    select_div.append(select_field);
    author_form_group.append(select_div);
    inline_form.append(author_form_group);

    inline_form.append(
      $(
        `<div class="form-group"><label for="bookauthor_set-${index}-role" class="mr-2">Role</label><div class="mr-2 mt-2"><input type="text" name="bookauthor_set-${index}-role" maxlength="255" class="textinput textInput form-control" id="id_bookauthor_set-${index}-role"></div></div>`
      )
    );
    inline_form.append(
      $(
        `<div class="form-group"><label for="bookauthor_set-${index}-order" class="mr-2">Order</label><div class="mr-2 mt-2"><input type="number" name="bookauthor_set-${index}-order" maxlength="255" class="textinput textInput form-control" id="id_bookauthor_set-${index}-role"></div></div>`
      )
    );
    inline_form.append(
      $(
        `<div class="form-group"><div class="mr-2 mt-2"><div class="form-check"><input type="checkbox" name="bookauthor_set-${index}-DELETE" class="checkboxinput form-check-input" id="id_bookauthor_set-${index}-DELETE"><label for="id_bookauthor_set-${index}-DELETE" class="form-check-label">Delete </label></div></div></div>`
      )
    );

    parent.append(inline_form);
    total_forms.val(index + 1);

    select_field.select2({ theme: "bootstrap", tags: "true" });
    inline_form.find(".form-check-input").on("click", function (event) {
      $(this).parent().parent().parent().parent().hide(1000);
    });
  }

  function add_listentry(event) {
    event.preventDefault();

    var parent = $("#formset-readinglistentry_set");
    var total_forms = $('input[name="readinglistentry_set-TOTAL_FORMS"]');
    var index = parseInt(total_forms.val());

    var inline_form = $('<div class="form-inline"></div>');
    var select_field = $(
      listentry_formset_template.replace(/__prefix__/g, index)
    ).find("select");

    var author_form_group = $('<div class="form-group"></div>');
    author_form_group.append(
      `<label for="id_readinglistentry_set-${index}-reading_list}" class="mr-2 requiredField">Reading list*</label>`
    );
    var select_div = $('<div class="mr-2 mt-2"></div>');
    select_div.append(select_field);
    author_form_group.append(select_div);
    inline_form.append(author_form_group);

    inline_form.append(
      $(
        `<div class="form-group"><label for="readinglistentry_set-${index}-order" class="mr-2">Order</label><div class="mr-2 mt-2"><input type="number" name="readinglistentry_set-${index}-order" maxlength="255" class="textinput textInput form-control" id="id_readinglistentry_set-${index}-role"></div></div>`
      )
    );
    inline_form.append(
      $(
        `<div class="form-group"><div class="mr-2 mt-2"><div class="form-check"><input type="checkbox" name="readinglistentry_set-${index}-DELETE" class="checkboxinput form-check-input" id="id_readinglistentry_set-${index}-DELETE"><label for="id_readinglistentry_set-${index}-DELETE" class="form-check-label">Delete </label></div></div></div>`
      )
    );

    parent.append(inline_form);
    total_forms.val(index + 1);

    select_field.select2({ theme: "bootstrap" });
    inline_form.find(".form-check-input").on("click", function (event) {
      $(this).parent().parent().parent().parent().hide(1000);
    });
  }
  </script>
{% endblock footer%}
