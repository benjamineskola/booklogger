{% from "macros.html" import link_amazon, link_goodreads, link_google with context %}
{% extends "base.html" %}
{% block content %}
  {% if form.instance.id %}
    <div class="card mb-2">
      <div class="card-body">
        <strong>Amazon</strong> {{ link_amazon(book) }}<br/>
        <strong>Goodreads</strong> {{ link_goodreads(book) }}<br/>
        <strong>Google</strong> {{ link_google(book) }}
      </div>
    </div>
  {% endif %}

  {% if form.errors %}
    <div class="alert alert-danger mb-2">
      {% for error in form.errors %}
        <p><strong>{{ error }}:</strong> {{ form.errors[error] | join('; ') }}</p>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <div class="row row-cols-1 row-cols-md-2">
      {% for field_names in [
        ["title", "subtitle", "first_author", "first_author_role", "first_published", "language", "series", "series_order", "slug"],
        ["edition_title", "edition_subtitle", "publisher", "edition_published", "edition_format", "edition_language", "edition_number", "page_count"],
        ["owned_by", "acquired_date", "alienated_date", "was_borrowed", "borrowed_from", "want_to_read"],
        ["goodreads_id", "google_books_id", "isbn", "asin", "image_url", "publisher_url"],
        ["has_ebook_edition", "ebook_acquired_date", "ebook_isbn", "ebook_asin"],
        ["tags", "review", "rating"],
        ["editions", "parent_edition"],
      ] %}
        {% if 'editions' not in field_names or ('editions' in form.fields or 'parent_edition' in form.fields) %}
          <div class="col">
            <div class="card mb-2">
              <div class="card-body">
                {% for field_name in field_names %}
                  {% set field = form[field_name] %}
                  {% if field %}
                    {{ field | crispy }}
                    {% for error in field.errors %}
                      <label for="{{ field.id_for_label }}" class="alert alert-warning">
                        {{ error|escape }}
                      </label>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              </div> {# card-body #}
            </div> {# card #}
          </div> {# column #}
        {% endif %}
      {% endfor %}
    </div> {# row #}

    {% for inline_formset in [bookauthor_formset, logentry_formset] %}
      <div class="card mb-2">
        <div class="card-body">
          {% if inline_formset.errors %}
            <div class="alert alert-danger">
              {% for error in inline_formset.errors %}
                <p><strong>{{ error }}:</strong> {{ inline_formset.errors[error] | join('; ') }}</p>
              {% endfor %}
            </div>
          {% endif %}
          {{ inline_formset.management_form }}
          {% for form in inline_formset %}
            <div class="form-inline">
              {{ form.id }}
              {% for field in form %}
                {% if field.name not in ["id", "book"] %}
                  {{ field | crispy(field_class="mr-2 mt-2", label_class="mr-2") }}
                  {% for error in field.errors %}
                    <label for="{{ field.id_for_label }}" class="alert alert-warning">
                      {{ error|escape }}
                    </label>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </div>
          {% endfor %}
        </div> {# card-body #}
      </div> {# card #}
    {% endfor %}

    <div class="col">
      <div class="card">
        <div class="card-body">
          <input type="submit" value="Submit" class="btn btn-primary">
          {% if form.instance.id %}
            <a href="{{ form.instance.get_absolute_url() }}" class="btn btn-secondary" role="button">Cancel</a>
            <a href="{{ url("library:book_delete", args=[form.instance.slug]) }}" class="btn btn-danger" role="button">Delete</a>
          {% else %}
            <a href="/" class="ui button">Cancel</a>
          {% endif %}
        </div> {# card-body #}
      </div> {# card #}
    </div> {# col #}
  </form>

  {% if form.instance.id %}
    <a href="{{ url("admin:library_book_change", args=[form.instance.id]) }}">Advanced</a>
  {% endif %}
{% endblock content %}

{% block footer %}
  <script>
    $(document).ready(function() {
      $('#id_tags').dropdown({'allowAdditions': true, 'values': {{ form.fields["tags"].widget.values_dict | json | safe }}});
      $("select").dropdown({ fullTextSearch: true });
    })
  </script>
{% endblock footer %}
