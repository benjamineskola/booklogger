{% from "macros.html" import link_amazon, link_goodreads, link_google with context %}
{% from "macros/card.html" import book_card with context %}
{% extends "base.html" %}

{% block header %}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css"
        rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
  <link rel="stylesheet"
        href="https://angel-vladov.github.io/select2-theme-bootstrap4/css/select2-bootstrap.css" />
  <style>
    .container {
      max-width: 100%;
    }
  </style>
{% endblock header %}

{% block content %}
  <form method="post">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    {% if formset.errors %}
      {% for error in formset.errors %}
        {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
      {% endfor %}
    {% endif %}
    {{ formset.management_form }}
    {% for form in formset %}
      <div class="form-inline">
        {{ form.id }}
        {% for field in form %}
          {% if field.name not in ["id", "book"] %}
            {{ field | crispy(field_class=" ", label_class=" ") }}
            {% for error in field.errors %}
              <label for="{{ field.id_for_label }}" class="alert alert-warning">{{ error|escape }}</label>
            {% endfor %}
          {% endif %}
        {% endfor %}
        <a href="{{ form.instance.get_absolute_url() }}"
           class="btn btn-secondary"
           role="button">View</a>
        <a href="{{ url("library:book_edit", args=[form.instance.slug]) }}"
           class="btn btn-danger"
           role="button">Edit</a>
      </div>
      <hr>
    {% endfor %}
    <input type="submit" value="Submit" class="btn btn-primary">
  </form>
{% endblock content %}

{% block footer %}
  <script>
    $(document).ready(function() {
        $('select').select2({
          theme: 'bootstrap',
        });
        for (var form_num=0; form_num < {{ formset.initial_form_count() }}; form_num++) {
          $(`#id_form-${form_num}_first_author, #id_form-${form_num}_publisher, #id_form-${form_num}_series, #formset-bookauthor_set select`).select2({
            theme: 'bootstrap',
            tags: true,
          });
          $(`#id_form-${form_num}_tags`).select2({
            theme: 'bootstrap',
            tags: true,
            tokenSeparators: [','],
          });

          {% for form in formset %}
            $(`#id_{{form.prefix}}_tags`).val({{ form.instance.tags | json | safe }});
            $(`#id_{{form.prefix}}_tags`).trigger('change');
          {% endfor %}
        }
    });
  </script>
{% endblock footer %}
