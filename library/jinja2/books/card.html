{% from "macros.html" import book_label, book_link, author_list, format_date, format_date_range with context %}
{% if not entry and book.log_entries and book.log_entries.count() > 0 %}
  {% set entry = book.log_entries.order_by('end_date').last() %}
{% endif %}


<div class="column">
  <div class="ui segments">
    <h5 class="ui top attached block header">
      <i>{{ book_link(book) }}</i>
      {% if book.display_series %}
        <a href="{{ url("library:series_details", args=[book.series]) }}" class="text-muted small">({{ book.display_series }})</a>
      {% endif %}
      by {{ author_list(book.authors, book=book) }}
    </h5>
    <div class="ui attached segment">
      <div class="row">
        <div class="ui {% if book.image_url %}two{% else %}one{% endif %} column grid">
          {% if book.image_url %}
          <img class="six wide column" src="{{ book.image_url }}" />
          {% endif %}
          <div class="column">
            ({{ book.display_date }})
            {% if book.edition_number and book.edition_number > 1 %} {{ book.edition_number | ordinal }} edn. {%endif %}{% if book.publisher %} {{ book.publisher }}.{% endif %}{% if book.page_count and book.page_count > 0 %} {{ book.page_count }}&nbsp;pages.
            {% endif %}

          {% if book.rating %}
            <span style="display: inline-block">
            {% set rating_floor = book.rating | float | round(0, 'floor') | int %}
            {% set rating_ceil = book.rating | float | round(0, 'ceil') | int %}

            {% for i in range(rating_floor) %}
              ★
            {% endfor %}
            {% if rating_floor != rating_ceil %}
              ½
            {% endif %}
            {% for i in range(rating_ceil, 5) %}
              ☆
            {% endfor %}
            </span>
          {% endif %}

            <hr class="ui divider" />
            <div class="ui labels tags" id="tags-{{ book.id }}">
              {% for tag in book.tags | sort %}
                {% if tag %}
                  {{ book_label(tag, url("library:tag_details", args=[tag])) }}
                {% endif %}
              {% else %}
                {{ book_label("untagged", url("library:tag_details", args=['untagged'])) }}
              {% endfor %}

              {% if book.owned %}
                {{ book_label("owned", url("library:books_owned"), True) }}
              {% elif book.owned_by_sara %}
                {{ book_label("shared", url("library:books_borrowed"), True) }}
              {% elif book.was_borrowed and book.borrowed_from == 'public domain' %}
                {{ book_label("public domain", url("library:books_borrowed"), True) }}
              {% elif book.was_borrowed %}
                {{ book_label("borrowed", url("library:books_borrowed"), True) }}
              {% endif %}

              {% if book.edition_format and (book.owned_by or book.was_borrowed or book.currently_reading) %}
                {{ book_label(book.get_edition_format_display().lower(), url("library:books_owned", kwargs={"format": book.get_edition_format_display().lower()}), True) }}
                {% if book.get_edition_format_display().lower() != "ebook" and book.has_ebook_edition %}
                {{ book_label("ebook", url("library:books_owned", kwargs={"format": "ebook"}), True) }}
                {% endif %}
              {% endif %}

              {% if book.currently_reading %}
                  {{ book_label("reading", url("library:books_currently_reading"), True) }}
              {% elif book.want_to_read and (book.owned_by or book.was_borrowed) %}
                  {{ book_label("to read", url("library:books_unread"), True) }}
              {% elif book.want_to_read and not book.was_borrowed %}
                  {{ book_label("wishlist", url("library:books_unowned"), True) }}
              {% endif %}
              {% if book.read %}
                  {{ book_label("read", url("library:books_read"), True) }}
              {% endif %}
              {% if user.is_authenticated %}
                <a class="ui label badge-secondary" data-toggle="collapse" data-target="#collapse-addtag-{{ book.id }}" role="button">+</a>
              {% endif %}
            </div>
          </div> <!-- column -->
        </div> <!-- two column grid -->
      </div> <!-- row -->
    </div> <!-- segment -->


      {% if user.is_authenticated %}
        <form class="ui attached segment form-addtag collapse" id="collapse-addtag-{{ book.id }}" data-tags="#tags-{{ book.id }}" action="{{url('library:book_add_tags', args=[book.slug]) }}?next={{ request.get_full_path() }}#{{ book.slug }}" method="post">
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
          <input class="form-control-sm m-1" name="tags">
        </form>
      {% endif %}
    {% if entry %}
      <p class="ui attached segment">
        {{ format_date_range(entry.start_date, entry.start_precision, entry.end_date, entry.end_precision)  }}
      </p>
      {% if entry.currently_reading %}
        <div class="ui attached segment">
          <div class="ui progress">
            <div class="bar" role="progressbar" style="width: {{entry.progress}}%" aria-valuenow="{{ entry.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          {% if entry.progress %}{{ entry.progress }}% on {{ format_date(entry.progress_date, 0) }}{% endif %}
        </div>
      {% endif %}
    {% endif %}

    <div class="ui bottom attached segment">
    {% if user.is_authenticated %}
      <a class="small dropdown-toggle" data-toggle="collapse" data-target="#collapse-logupdate-{{ book.id}}{% if entry and entry.start_date %}-{{ entry.start_date.date() }}{% endif %}" role="button">Update</a>
      <div class="collapse" id="collapse-logupdate-{{book.id}}{% if entry and entry.start_date %}-{{ entry.start_date.date() }}{% endif %}">
        {% include "books/update_form_snippet.html" %}
      </div>
    {% endif %}
    </div>
  </div>
</div>
